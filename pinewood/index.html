<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinewood Derby Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4">Pack 1 Pinewood Derby Scheduler</h1>

        <p>This tool accepts CSV input (copied/pasted from Google Sheets, for instance) and schedules race heats in a format suitable for import to the pack's Pinewood Derby race day software. It's designed to ensure every car races a set number of times, while optimizing for inside lane use when not all lanes are active. Please be sure that the CSV content you use as input includes headers for columns named "Subgroup" and "Car#". "Subgroup" should typically be the car creator's den (e.g. "Lion", "Webelos"). "Car#" should be unique.</p>

        <label class="block font-semibold mb-2">Input CSV (Copy/Paste):</label>
        <textarea id="inputCsv" class="w-full h-32 p-2 border border-gray-300 rounded-md"></textarea>

        <div class="flex gap-4 my-4">
            <div>
                <label class="block font-semibold">Number of Lanes:</label>
                <select id="laneCount" class="p-2 border border-gray-300 rounded-md">
                    <script>
                        for (let i = 2; i <= 16; i++) {
                            document.write(`<option value="${i}" ${i === 8 ? 'selected' : ''}>${i}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div>
                <label class="block font-semibold">Minimum Heats per Car:</label>
                <select id="minHeats" class="p-2 border border-gray-300 rounded-md">
                    <script>
                        for (let i = 1; i <= 10; i++) {
                            document.write(`<option value="${i}" ${i === 3 ? 'selected' : ''}>${i}</option>`);
                        }
                    </script>
                </select>
            </div>
        </div>

        <button onclick="processCsv()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Generate Schedule</button>

        <h2 class="text-xl font-semibold mt-6">Generated Heats:</h2>
        <div id="outputPreview" class="overflow-x-auto mt-2 p-2 border border-gray-300 rounded-md bg-gray-50"></div>

        <a id="downloadLink" class="hidden mt-4 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" download="race_schedule.csv">Download CSV</a>
    </div>

    <script>
        function parseCsv(text) {
            let rows = text.trim().split("\n").map(row => row.split(","));
            let headers = rows.shift();
            return rows.map(row => Object.fromEntries(headers.map((h, i) => [h.trim(), row[i]?.trim()])));
        }

        function distributeLanes(occupied, laneCount) {
            let lanes = Array(laneCount).fill("Bye");

            let middleStart = Math.floor((laneCount - occupied.length) / 2);
            for (let i = 0; i < occupied.length; i++) {
                lanes[middleStart + i] = occupied[i];
            }
            return lanes;
        }

        function makeRaces(den, minHeats, laneCount) {
            den.sort((a, b) => a['Car#'].localeCompare(b['Car#']));
            let carNumbers = den.map(x => x['Car#']);
            let offset = 0, raceCount = Object.fromEntries(carNumbers.map(cn => [cn, 0]));
            let heats = [], remainingRacers = [...carNumbers];

            while (remainingRacers.length) {
                let rowCars = [];
                for (let i = 0; i < Math.min(laneCount, remainingRacers.length); i++) {
                    let cn = remainingRacers[(i + offset) % remainingRacers.length];
                    rowCars.push(cn);
                    raceCount[cn]++;
                }

                let row = distributeLanes(rowCars, laneCount);
                heats.push([den[0]['Subgroup'], ...row]);
                offset++;

                remainingRacers = carNumbers.filter(x => raceCount[x] < minHeats);
            }
            return heats;
        }

        function processCsv() {
            let inputCsv = document.getElementById("inputCsv").value;
            let laneCount = parseInt(document.getElementById("laneCount").value);
            let minHeats = parseInt(document.getElementById("minHeats").value);
            
            let data = parseCsv(inputCsv);
            let dens = data.reduce((acc, row) => {
                (acc[row['Subgroup']] = acc[row['Subgroup']] || []).push(row);
                return acc;
            }, {});

            let heats = [];
            for (let den in dens) {
                heats.push(...makeRaces(dens[den], minHeats, laneCount));
            }

            displayOutput(heats, laneCount);
        }

        function displayOutput(heats, laneCount) {
            let preview = document.getElementById("outputPreview");
            let outputData = [['Lane 1', ...Array.from({length: laneCount - 1}, (_, i) => `Lane ${i+2}`)]];
            let csvData = [];

            preview.innerHTML = `<table class="min-w-full bg-white border border-gray-300 text-sm">
                ${heats.map(row => {
                    let lanesOnly = row.slice(1);
                    csvData.push(lanesOnly);
                    return `<tr>${lanesOnly.map(cell => `<td class="border px-2 py-1">${cell}</td>`).join('')}</tr>`;
                }).join('')}
            </table>`;

            let csvContent = csvData.map(row => row.join(",")).join("\n");
            let blob = new Blob([csvContent], { type: "text/csv" });
            let url = URL.createObjectURL(blob);
            let downloadLink = document.getElementById("downloadLink");
            downloadLink.href = url;
            downloadLink.classList.remove("hidden");
        }
    </script>
</body>
</html>